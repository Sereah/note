## 音频基础

### 物理本质

#### 频率 Frequency

决定高音，单位赫兹，Hz。

常见频率：

- 20Hz - 20kHz: 人耳听到的范围
- 3kHz - 4kHz: 人耳最敏感
- 8kHz: 传统电话语音带宽的上限
- 440Hz: A4音，大部分乐器调音的基准
- 261.63Hz: C4音，中音C
- 880Hz, 220Hz: A5和A3，音乐里一个八度就是频率翻倍或减半
- 1kHz: 常用于设备测试的标准正弦波

#### 振幅 Amplitude

决定响度，单位分贝，dB

#### 波形 Waveform

决定音色，区分乐器或人声

--------------------------------------------------------------

### 数字化 PCM编码

#### 采样率 Sampling

时间离散化，在时间轴上提取样本，每秒取多少个样本，基于奈奎斯特定理，采样率至少是频率的两倍。单位：Hz。

常见采样率：

- 8kHz: 电话采样率
- 16kHz: 语音识别
- 44.1kHz: CD音质
- 48kHz: DVD、专业音频

#### 量化 Quantization

幅度离散化，将采样点的连续幅度量化到具体范围，用多少bit来表示一个采样点，也就是位深，位深越大，精度就越大，噪音越少。单位：Bit。

常见位深度：

- 8bit: 电话
- 16bit: CD/主流
- 24bit: 专业录音

#### 声道 Channel

每个声道独立采样量化，一般有单声道，立体声，5.1环绕声等，存储的时候同时听到的话是交叉存储。

--------------------------------------------------------------

### 数据量

示例： 44.1kHZ，16bit，双声道，10秒的音频

#### PCM文件大小

文件大小（Bytes） = 采样率 x 位深 x 声道数 x 时长(秒) ÷ 8

44100 x 16 x 2 x 10 ÷ 8 = 1764000 Bytes ≈ 1.68 MB

> 除以8就是字节Byte，不除以就是比特Bit。

#### PCM码率

码率表示每秒需要多少Bit来存储/传输。

码率（bps） = 采样率 x 位深 x 声道数

44100 x 16 x 2 = 1411200 bps ≈ 1.441 Mbps

--------------------------------------------------------------

### 压缩编码

#### 有损压缩

去掉人耳不敏感的信号，减少数据，例如，高频微小声音被掩蔽、同频段强声音覆盖弱声音、高于16KHz以上的声音，然后将剩余的信号进行编码和量化，体积大幅减少。

主流编码格式：

- MP3: 音乐
- AAC: 目前主流，广泛用于MP4容器、HLS流媒体、各类短视频和音乐App。
- Opus: 实时通信领域的王者，低延迟、高容错性，常用于VoIP、视频会议。

#### 无损压缩

常见编码格式：

- FLAC
- ALAC
- APE

--------------------------------------------------------------

### 代码实践

#### 编写pcm文件

```cpp

#include <fstream>
#include <ios>
#include <iosfwd>
#include <iostream>
#include <cmath>
#include <cstdint>

int create_mi_pcm() {
    constexpr int duration = 1; //音频持续时间，s
    constexpr int sampleRate = 44100; //采样率，Hz
    constexpr double amplitude = 32767.0 * 0.8; //最大振幅，位深16bit
    constexpr double totalSample = sampleRate * duration; //总采样点数量

    std::ofstream out("mi.pcm", std::ios::binary); //二进制打开文件
    if (out.fail()) {
        std::cerr << "Couldn't open mi.pcm" << std::endl;
        return 1;
    }

    // 使用公式 y(t) = A·sin(2πft + φ)
    for (int n = 0; n < totalSample; ++n) {
        constexpr double miFrequency = 659.26; // mi的频率
        const double phaseAngle = 2 * M_PI * miFrequency * n / sampleRate; // 相角 = 2π x 频率 x 采样的时间点(采样点/采样率)
        const double a = std::sin(phase); // 计算振幅比例，-1 至 1
        auto amp = static_cast<int16_t>(a * amplitude); // PCM值 = 振幅比例 x 最大振幅值
        out.write(reinterpret_cast<char *>(&amp), sizeof(amp)); // 2字节的存入内存
    }

    out.close();

    return 0;
}

int main() {
    create_mi_pcm();
}

```

#### ffplay播放

`ffplay -f s16le -ch_layout mono -sample_rate 44100 -i raw`

- s16le: 16bit位深
- mono: 单声道
- 44100: 采样频率
- raw: pcm文件
